<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Teachable Machine Mobile</title>

<style>
/* ğŸŒˆ ì „ì²´ ë°°ê²½ */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #e0eafc, #cfdef3);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

/* ğŸ“¦ ì¹´ë“œ */
.card {
  background: white;
  width: 90%;
  max-width: 360px;
  padding: 20px;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}

/* ğŸ¥ ì›¹ìº  */
canvas {
  width: 100%;
  border-radius: 20px;
  margin-top: 10px;
}

/* ğŸ”˜ ë²„íŠ¼ */
button {
  background: linear-gradient(135deg, #ff9966, #ff5e62);
  color: white;
  border: none;
  border-radius: 30px;
  padding: 14px 28px;
  font-size: 18px;
  cursor: pointer;
}
button:active {
  transform: scale(0.95);
}

/* ğŸ· ê²°ê³¼ ë°°ì§€ */
#label-container {
  margin-top: 15px;
  font-size: 26px;
  font-weight: bold;
  color: white;
  padding: 12px;
  border-radius: 999px;
  transition: background 0.3s, transform 0.3s;
}

/* ğŸ¯ ìƒíƒœë³„ ìƒ‰ìƒ */
.state-rock {
  background: linear-gradient(135deg, #ff512f, #dd2476);
}
.state-paper {
  background: linear-gradient(135deg, #24c6dc, #514a9d);
}
.state-unknown {
  background: linear-gradient(135deg, #999, #666);
}

/* ğŸ¬ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle {
  0%   { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
  50%  { transform: scale(1.15); box-shadow: 0 0 25px rgba(255,255,255,0.9); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
}

.sparkle {
  animation: sparkle 0.5s ease-out;
}
</style>
</head>

<body>

<div class="card">
  <h2>ğŸ“± ê°€ìœ„ë°”ìœ„ë³´ ì¸ì‹</h2>
  <button onclick="init()">Start</button>

  <div id="webcam-container"></div>
  <div id="label-container" class="state-unknown">ëŒ€ê¸° ì¤‘</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
const URL = "./my_model/";

let model, webcam, labelContainer;
let lastSpoken = "";
let lastSpeakTime = 0;
const SPEAK_COOLDOWN = 1500; // 1.5ì´ˆ
let lastPredictTime = 0;
const PREDICT_INTERVAL = 500;

/* ğŸ”Š ìŒì„± */
function speak(text) {
  if (speechSynthesis.speaking) return;

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ko-KR";
  speechSynthesis.speak(u);
}

/* ğŸš€ ì‹œì‘ */
async function init() {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";

  model = await tmImage.load(modelURL, metadataURL);

  const size = Math.min(window.innerWidth * 0.8, 300);

  webcam = new tmImage.Webcam(size, size, true);
  await webcam.setup({ facingMode: "environment" });
  await webcam.play();

  window.requestAnimationFrame(loop);

  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);

  labelContainer = document.getElementById("label-container");
  labelContainer.innerHTML = "ì¸ì‹ ì¤‘...";
}

/* ğŸ” ë£¨í”„ */
async function loop(time) {
  webcam.update();

  if (time - lastPredictTime > PREDICT_INTERVAL) {
    await predict();
    lastPredictTime = time;
  }

  window.requestAnimationFrame(loop);
}

/* ğŸ§  ì˜ˆì¸¡ */
async function predict() {
  const prediction = await model.predict(webcam.canvas);

  const best = prediction.reduce((a, b) =>
    a.probability > b.probability ? a : b
  );

  const now = Date.now();

  if (best.probability > 0.9) {

    applyState(best.className);

    // ğŸ”Š ìŒì„± + ì• ë‹ˆë©”ì´ì…˜ (ì¿¨íƒ€ì„ ì ìš©)
    if (
      best.className !== lastSpoken &&
      now - lastSpeakTime > SPEAK_COOLDOWN
    ) {
      speak(best.className);
      sparkle();

      lastSpoken = best.className;
      lastSpeakTime = now;
    }

  } else {
    // â— lastSpoken ì´ˆê¸°í™” âŒ (ì œê±°!)
    applyUnknown();
  }
}

/* ğŸ¯ ìƒíƒœ ì ìš© */
function applyState(name) {
  labelContainer.className = "";

  if (name === "ì£¼ë¨¹") {
    labelContainer.innerHTML = "ì£¼ë¨¹";
    labelContainer.classList.add("state-rock");
  } else if (name === "ë³´ìê¸°") {
    labelContainer.innerHTML = "ë³´ìê¸°";
    labelContainer.classList.add("state-paper");
  }
}

/* â“ ì•Œ ìˆ˜ ì—†ìŒ */
function applyUnknown() {
  labelContainer.innerHTML = "ì•Œ ìˆ˜ ì—†ìŒ";
  labelContainer.className = "state-unknown";
}

/* ğŸ¬ ë°˜ì§ íš¨ê³¼ */
function sparkle() {
  labelContainer.classList.remove("sparkle");
  void labelContainer.offsetWidth; // ë¦¬ì…‹ íŠ¸ë¦­
  labelContainer.classList.add("sparkle");
}
</script>

</body>
</html>